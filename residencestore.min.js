(function(){window.ResidenceStore=function(e){if(e.substr(e.length-1,1)!="/")e+="/";this.verifier=e;this.verifierTimeout=3e4;this.allEmails=function(e){return this.storage.all().map(function(e){return e.email})};this.isEmailRegistered=function(e){return this.storage.getResidence(e)!=null};this.residenceForEmail=function(e){var t=this.storage.getResidence(e);return t?t.residence:null};this.isEmailVerifying=function(e){var t=this.storage.getResidence(e);return t&&t.verificationToken};this.residenceTokenForEmail=function(e){var t=this.storage.getResidence(e);return t?t.authorizationToken:null};this.registerResidence=function(e,t,n){if(typeof n==="undefined"&&typeof t==="function"){n=t;t=null}if(!e||e.length==0){n(false);return}var r=this.storage.getResidence(e);if(!r){r={email:e,residence:this.generateTokenForEmail(e)};this.storage.putResidence(r)}var i={email:r.email,residence:r.residence};if(typeof t!=="undefined")i.userInfo=t;$.ajax(this.verifier,{timeout:this.verifierTimeout,data:i,type:"POST",context:this}).done(function(t){if(!t.verificationToken||t.email!=e){n(false)}r.verificationToken=t.verificationToken;delete r.authorizationToken;this.storage.putResidence(r);n(true)},this).fail(function(e,t,r){n(false,t,r)},this)}.bind(this);this.verifyResidence=function(e,t){if(!e||e.length==0){t(false);return}var n=this.storage.getResidence(e);var r=null,i=null;if(n){r=n.verificationToken||n.authorizationToken;i=n.residence}if(!i||!r){t(false);return}var s={Authorization:r,"X-Residence":n};$.ajax(this.verifier,{timeout:this.verifierTimeout,cache:false,headers:s,type:"GET",context:this}).done(function(r){if(!r.authorizationToken||r.email!=e){t(false)}n.authorizationToken=r.authorizationToken;delete n.verificationToken;this.storage.putResidence(n);t(true,r.authorizationToken)},this).fail(function(e,n,r){t(false,n,r)},this)}.bind(this);this.removeResidence=function(e,t){if(!e||e.length==0){t(false);return}var n=this.storage.getResidence(e);var r=null,i=null;if(n){r=n.authorizationToken;i=n.residence}if(!i||!r){t(false);return}var s={"X-Residence":n};$.ajax(this.verifier+r,{timeout:this.verifierTimeout,cache:false,headers:s,type:"DELETE",context:this}).done(function(e){this.storage.removeResidence(n.email);t(true)},this).fail(function(e,n,r){t(false,n,r)},this)}.bind(this);this.uniqueIdentifierForEmail=function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)});return t+e};this.generateTokenForEmail=function(e){if(!e||e.length==0)return null;var t=this.uniqueIdentifierForEmail(e);var n=CryptoJS.SHA1(t);if(!n)return null;return n.toString(CryptoJS.enc.Hex)}.bind(this);var t=this;this.storage={all:function(){var e=[];for(var n=0;n<window.localStorage.length;++n){if(window.localStorage.key(n).indexOf("ResidenceStore#"+t.verifier)>=0){var r=window.localStorage.getItem(window.localStorage.key(n));e.push(JSON.parse(r))}}return e},getResidence:function(e){if(!e||e.length==0)return null;var n="ResidenceStore#"+t.verifier+"#"+e;var r=window.localStorage[n];if(!r)return null;return JSON.parse(r)},putResidence:function(e){if(!e||!e.email)return;var n="ResidenceStore#"+t.verifier+"#"+e.email;window.localStorage.setItem(n,JSON.stringify(e))},removeResidence:function(e){if(!e||e.length==0)return;var n="ResidenceStore#"+t.verifier+"#"+e;window.localStorage.removeItem(n)},removeAll:function(){var e=[];for(var n=0;n<window.localStorage.length;++n){if(window.localStorage.key(n).indexOf("ResidenceStore#"+t.verifier)>=0)e.push(window.localStorage.key(n))}for(var r in e){window.localStorage.removeItem(r)}}}}})()